version: '3'
services:

  dbmysql:
    image: mysql:8.0.22
    command: mysqld --sql_mode=""
    volumes:
      - db-app-name:/var/lib/mysql
    env_file:
      - .env.local
    environment:
      MYSQL_DATABASE:
      MYSQL_USER:
      MYSQL_PASSWORD:
      MYSQL_ROOT_PASSWORD:
    networks:
      - dev

  phpmyadmin:
    image: phpmyadmin
    env_file:
      - .env.local
    environment:
      PMA_HOST: dbmysql
      MYSQL_DATABASE:
      MYSQL_USER:
      MYSQL_PASSWORD:
      MYSQL_ROOT_PASSWORD:
    ports:
      - "80"
    networks:
      - dev

  app-name: &app-name
    image: app-name
    build: .
    env_file:
      - .env.local
    environment:
      - PHP_CLI_MEMORY_LIMIT="1024M"
    ports:
      - "${APP_PORT}:8080"
    volumes:
      - ./:/var/www
    networks:
      - dev

  xdebug:
    <<: *app-name
    profiles: ["xdebug"]
    env_file:
      - .env.local
      - .env.xdebug
    ports:
      - "8080"
    extra_hosts:
      # https://stackoverflow.com/a/67158212
      # only works with Docker v20.10+
      - "host.docker.internal:host-gateway"

  test:
    <<: *app-name
    profiles:
      - test
    env_file:
      - .env.local
      - .env.test

networks:
  dev:
    external: false
    name: 'app-name_dev'

volumes:
  db-app-name:
